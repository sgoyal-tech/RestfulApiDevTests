name: API Tests CI Pipeline

# Trigger the workflow on push or pull request
on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:  # Allows manual triggering from GitHub UI

env:
  DOTNET_VERSION: '8.0.x'
  PROJECT_PATH: 'RestfulApiDevTests/RestfulApiDevTests.csproj'

jobs:
  test:
    name: Run API Tests
    runs-on: windows-latest
    
    steps:
      # Step 1: Checkout the repository
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for better analysis

      # Step 2: Setup .NET SDK
      - name: ğŸ”§ Setup .NET ${{ env.DOTNET_VERSION }}
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      # Step 3: Display .NET version
      - name: ğŸ“‹ Display .NET version
        run: dotnet --version

      # Step 4: Restore dependencies
      - name: ğŸ“¦ Restore Dependencies
        run: dotnet restore "${{ env.PROJECT_PATH }}"

      # Step 5: Build the project
      - name: ğŸ—ï¸ Build Project
        run: dotnet build "${{ env.PROJECT_PATH }}" --configuration Release --no-restore

      # Step 6: Run the tests
      - name: ğŸ§ª Run API Tests
        shell: pwsh
        run: |
          dotnet test "${{ env.PROJECT_PATH }}" `
            --configuration Release `
            --no-build `
            --verbosity normal `
            --logger "trx;LogFileName=test-results.trx" `
            --logger "html;LogFileName=test-results.html" `
            --results-directory TestResults
        continue-on-error: true  # Continue to upload results even if tests fail

      # Step 7: Publish test results
      - name: ğŸ“Š Publish Test Results
        uses: EnricoMi/publish-unit-test-result-action/composite@v2
        if: always()  # Run even if previous steps fail
        with:
          files: |
            TestResults/**/*.trx
          check_name: 'API Test Results'
          comment_title: 'ğŸ§ª API Test Results'

      # Step 8: Upload test results as artifacts
      - name: ğŸ“¤ Upload Test Results Artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: TestResults/
          retention-days: 30

      # Step 9: Generate test summary
      - name: ğŸ“ Generate Test Summary
        if: always()
        shell: pwsh
        run: |
          $summary = @"
          # ğŸ§ª API Test Execution Summary
          
          ## Test Configuration
          - **API Under Test**: restful-api.dev
          - **Endpoint Tested**: PATCH /objects/{id}
          - **.NET Version**: ${{ env.DOTNET_VERSION }}
          - **OS**: Windows
          - **Run Date**: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')
          - **Commit**: ${{ github.sha }}
          
          "@
          
          if (Test-Path "TestResults\test-results.trx") {
            $summary += "`nâœ… Test results generated successfully`n"
            $summary += "`nğŸ“Š Test results are available in the artifacts section`n"
          } else {
            $summary += "`nâš ï¸ Test results file not found`n"
          }
          
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value $summary

      # Step 10: Check test outcome and fail if needed
      - name: âœ… Verify Test Results
        shell: pwsh
        run: |
          if (Test-Path "TestResults\test-results.trx") {
            $content = Get-Content "TestResults\test-results.trx" -Raw
            if ($content -match 'outcome="Failed"') {
              Write-Host "âŒ Some tests failed!"
              exit 1
            } else {
              Write-Host "âœ… All tests passed!"
            }
          } else {
            Write-Host "âš ï¸ Could not verify test results"
            exit 1
          }

  # Job for reporting status
  report-status:
    name: Report Status
    runs-on: windows-latest
    needs: test
    if: always()
    
    steps:
      - name: ğŸ“¢ Report Success
        if: needs.test.result == 'success'
        run: |
          echo "::notice::âœ… All API tests passed successfully!"
          
      - name: ğŸ“¢ Report Failure
        if: needs.test.result == 'failure'
        run: |
          echo "::error::âŒ Some API tests failed. Please check the test results."
          exit 1